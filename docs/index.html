<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LP Race Tracker</title>
  <style>
    :root{
      --ink: #0b0e14;
      --ink2:#0f1420;
      --paper:#f2efe8;
      --paper2:#e8e2d4;

      --gold:#d7b86a;
      --gold2:#b79245;
      --teal:#2bb3a3;
      --red:#d0635e;

      --text:#111827;
      --muted:#4b5563;

      --card:#ffffffcc;
      --card2:#ffffffaa;
      --stroke:#d7cfbf;
      --shadow: 0 10px 30px rgba(0,0,0,0.18);

      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);

      /* Parchment base + “ink wash” corners */
      background:
        radial-gradient(1000px 700px at 10% 0%, rgba(15,20,32,0.70), transparent 55%),
        radial-gradient(900px 700px at 100% 10%, rgba(11,14,20,0.70), transparent 55%),
        linear-gradient(180deg, var(--paper), var(--paper2));

      min-height: 100vh;
    }

    /* subtle parchment texture without images */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background:
        repeating-linear-gradient(
          0deg,
          rgba(0,0,0,0.015) 0px,
          rgba(0,0,0,0.015) 1px,
          transparent 1px,
          transparent 6px
        ),
        repeating-linear-gradient(
          90deg,
          rgba(0,0,0,0.010) 0px,
          rgba(0,0,0,0.010) 1px,
          transparent 1px,
          transparent 9px
        );
      mix-blend-mode:multiply;
      opacity:0.35;
    }

    .wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 28px 18px 60px;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:14px;
      margin-bottom: 16px;
    }

    .titleBlock{
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    h1{
      margin:0;
      font-size: 28px;
      letter-spacing: 0.4px;
      font-weight: 800;
      color: #f6f2e7;
      text-shadow: 0 2px 12px rgba(0,0,0,0.50);
    }

    .subtitle{
      color: rgba(246,242,231,0.80);
      font-size: 13px;
      letter-spacing: 0.2px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.35);
    }

    .updated{
      text-align:right;
      color: rgba(246,242,231,0.85);
      font-size: 13px;
      line-height:1.35;
      white-space:nowrap;
      text-shadow: 0 2px 10px rgba(0,0,0,0.35);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
      margin-top: 14px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
      .updated{ text-align:left; white-space:normal; }
      .topbar{ flex-direction:column; align-items:flex-start; }
    }

    .card{
      position:relative;
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid rgba(215, 207, 191, 0.85);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* gold trim */
    .card::before{
      content:"";
      position:absolute;
      inset:0;
      border-radius: var(--radius);
      padding: 1px;
      background: linear-gradient(135deg, rgba(215,184,106,0.85), rgba(183,146,69,0.55), rgba(43,179,163,0.35));
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events:none;
    }

    .cardInner{
      padding: 16px;
    }

    .cardHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(215, 207, 191, 0.7);
    }

    .riotId{
      margin:0;
      font-weight: 850;
      font-size: 18px;
      letter-spacing: 0.3px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(215, 207, 191, 0.9);
      background: rgba(242,239,232,0.65);
      color: #2b2f38;
      font-size: 12px;
      white-space:nowrap;
    }

    code{
      background: rgba(11,14,20,0.08);
      padding: 2px 6px;
      border-radius: 10px;
      border: 1px solid rgba(11,14,20,0.12);
    }

    .section{
      padding-top: 12px;
    }

    .labelRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:baseline;
      margin-bottom: 8px;
    }

    .labelRow .k{
      font-size: 12px;
      color: var(--muted);
      letter-spacing:0.2px;
    }
    .labelRow .v{
      font-size: 13px;
      font-weight: 800;
      letter-spacing:0.2px;
    }

    /* Progress bar: “etched” track + gold fill */
    .bar{
      height: 14px;
      border-radius: 999px;
      background:
        linear-gradient(180deg, rgba(11,14,20,0.08), rgba(11,14,20,0.03));
      border: 1px solid rgba(11,14,20,0.12);
      overflow:hidden;
      position:relative;
    }
    .fill{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background:
        linear-gradient(90deg, rgba(215,184,106,0.95), rgba(183,146,69,0.95));
      transition: width 350ms ease;
      position:relative;
    }
    .fill::after{
      content:"";
      position:absolute;
      inset:0;
      background:
        repeating-linear-gradient(
          90deg,
          rgba(255,255,255,0.18) 0px,
          rgba(255,255,255,0.18) 2px,
          transparent 2px,
          transparent 10px
        );
      opacity: 0.35;
      mix-blend-mode: overlay;
      pointer-events:none;
    }

    .ticks{
      display:flex;
      justify-content:space-between;
      gap:8px;
      margin-top: 10px;
      font-size: 11px;
      color: rgba(75,85,99,0.85);
    }
    .tick{
      flex:1;
      text-align:center;
      position:relative;
      padding-top: 10px;
    }
    .tick::before{
      content:"";
      position:absolute;
      top:0;
      left:50%;
      transform: translateX(-50%);
      width: 2px;
      height: 8px;
      background: rgba(11,14,20,0.22);
      border-radius: 2px;
    }
    .tick.active{
      color: rgba(17,24,39,0.95);
      font-weight: 800;
    }
    .tick.active::before{
      background: rgba(183,146,69,0.85);
    }

    .metaLine{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(75,85,99,0.92);
      line-height: 1.35;
    }
    .metaLine b{ color: rgba(17,24,39,0.98); }

    .kvs{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 12px;
      margin-top: 12px;
    }
    @media (max-width: 560px){
      .kvs{ grid-template-columns: 1fr; }
    }

    .kv{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(11,14,20,0.10);
      background: rgba(242,239,232,0.60);
    }
    .kv .k{
      font-size: 12px;
      color: rgba(75,85,99,0.90);
      margin-bottom: 4px;
    }
    .kv .v{
      font-size: 14px;
      font-weight: 850;
      letter-spacing:0.2px;
    }

    .footnote{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(75,85,99,0.80);
      line-height:1.35;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="titleBlock">
        <h1>LP Race Tracker</h1>
        <div class="subtitle">NA • Solo/Duo • Goal: Emerald IV (0 LP counts)</div>
      </div>
      <div class="updated" id="updated">Last Updated: …</div>
    </div>

    <div class="grid" id="cards"></div>
  </div>

<script>
  // --- Time formatting (America/New_York) ---
  function formatLastUpdated(isoString){
    if (!isoString) return { display: "Last Updated: unknown", rel: "" };

    const dt = new Date(isoString);
    const parts = new Intl.DateTimeFormat("en-US", {
      timeZone: "America/New_York",
      month: "2-digit",
      day: "2-digit",
      hour: "numeric",
      minute: "2-digit",
      hour12: true
    }).formatToParts(dt);

    const get = (type) => parts.find(p => p.type === type)?.value;
    const mm = get("month");
    const dd = get("day");
    const hh = get("hour");
    const min = get("minute");
    const ap = get("dayPeriod"); // AM/PM

    const display = `Last Updated: ${hh}:${min}${ap} on ${mm}/${dd}`;

    const now = new Date();
    const diffSec = Math.max(0, Math.floor((now - dt) / 1000));

    let rel;
    if (diffSec < 10) rel = "just now";
    else if (diffSec < 60) rel = `${diffSec} seconds ago`;
    else if (diffSec < 3600) rel = `${Math.floor(diffSec/60)} minutes ago`;
    else if (diffSec < 86400) rel = `${Math.floor(diffSec/3600)} hours ago`;
    else rel = `${Math.floor(diffSec/86400)} days ago`;

    return { display, rel };
  }

  // --- Progress / milestones (goal: Emerald IV at 0 LP) ---
  const MILESTONES = [
    { tier: "PLATINUM", div: "IV", label: "Plat IV" },
    { tier: "PLATINUM", div: "III", label: "Plat III" },
    { tier: "PLATINUM", div: "II", label: "Plat II" },
    { tier: "PLATINUM", div: "I", label: "Plat I" },
    { tier: "EMERALD",  div: "IV", label: "Emerald IV" }
  ];

  const tierOrder = {
    "IRON": 0, "BRONZE": 1, "SILVER": 2, "GOLD": 3,
    "PLATINUM": 4, "EMERALD": 5, "DIAMOND": 6,
    "MASTER": 7, "GRANDMASTER": 8, "CHALLENGER": 9
  };
  const divOrder = {"IV": 0, "III": 1, "II": 2, "I": 3};

  function rankValue(tier, div, lp){
    const t = tierOrder[tier] ?? -1;
    const d = divOrder[div] ?? 0;
    const L = Number.isFinite(lp) ? lp : 0;
    return t * 10000 + d * 1000 + L;
  }

  function progressToEmerald(cur){
    if (!cur) return { pct: 0, reachedIndex: -1, curLabel: "Unranked / placements" };

    const curV = rankValue(cur.tier, cur.division, cur.lp);

    const start = MILESTONES[0];
    const goal  = MILESTONES[MILESTONES.length - 1];

    const startV = rankValue(start.tier, start.div, 0);
    const goalV  = rankValue(goal.tier,  goal.div,  0); // Emerald IV at 0 LP

    const raw = (curV - startV) / (goalV - startV);
    const pct = Math.max(0, Math.min(1, raw));

    let reachedIndex = -1;
    for (let i = 0; i < MILESTONES.length; i++){
      const m = MILESTONES[i];
      const mv = rankValue(m.tier, m.div, 0);
      if (curV >= mv) reachedIndex = i;
    }

    return { pct, reachedIndex, curLabel: `${cur.tier} ${cur.division} — ${cur.lp} LP` };
  }

  async function load(){
    const res = await fetch("./data.json", { cache: "no-store" });
    const data = await res.json();

    const updatedIso = data?.updatedAt?.iso ?? data?.updatedAt;
    const { display, rel } = formatLastUpdated(updatedIso);
    document.getElementById("updated").textContent = rel ? `${display} (${rel})` : display;

    const cards = document.getElementById("cards");
    cards.innerHTML = "";

    for (const [key, p] of Object.entries(data.players || {})){
      const cur = p.current;
      const s = p.stats || {};
      const winrate = cur && cur.winrate != null ? (cur.winrate * 100).toFixed(1) + "%" : "n/a";
      const peakText = p.peak ? `${p.peak.tier} ${p.peak.division} — ${p.peak.lp} LP` : "n/a";

      const prog = progressToEmerald(cur);
      const pctLabel = `${Math.round(prog.pct * 100)}%`;

      const ticksHtml = MILESTONES.map((m, i) => {
        const cls = (i <= prog.reachedIndex) ? "tick active" : "tick";
        return `<div class="${cls}">${m.label}</div>`;
      }).join("");

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="cardInner">
          <div class="cardHeader">
            <h2 class="riotId">${p.riotId}</h2>
            <div class="pill">Key: <b><code>${key}</code></b></div>
          </div>

          <div class="section">
            <div class="labelRow">
              <div class="k">Race Progress</div>
              <div class="v">${pctLabel}</div>
            </div>
            <div class="bar"><div class="fill" style="width:${(prog.pct*100).toFixed(2)}%"></div></div>
            <div class="ticks">${ticksHtml}</div>

            <div class="metaLine">
              Current: <b>${cur ? prog.curLabel : "Unranked / placements"}</b><br/>
              Peak (since tracking): <b>${peakText}</b>
            </div>
          </div>

          <div class="section">
            <div class="kvs">
              <div class="kv">
                <div class="k">Games (Solo/Duo)</div>
                <div class="v">${cur ? cur.games : (s.games ?? 0)} (W ${cur ? cur.wins : (s.wins ?? 0)} / L ${cur ? cur.losses : (s.losses ?? 0)})</div>
              </div>
              <div class="kv">
                <div class="k">Overall winrate</div>
                <div class="v">${winrate}</div>
              </div>
              <div class="kv">
                <div class="k">Total playtime (tracked)</div>
                <div class="v">${s.totalPlaytimeHMS || "0:00:00"}</div>
              </div>
              <div class="kv">
                <div class="k">Most played champ (ID)</div>
                <div class="v">${s.mostPlayedChampionId ?? "n/a"}</div>
              </div>
              <div class="kv">
                <div class="k">Highest WR champ (min 5 games)</div>
                <div class="v">${s.highestWinrateChampionId ?? "n/a"}${s.highestWinrateChampionWR != null ? ` • ${(s.highestWinrateChampionWR*100).toFixed(1)}%` : ""}</div>
              </div>
              <div class="kv">
                <div class="k">Lowest WR champ (min 5 games)</div>
                <div class="v">${s.lowestWinrateChampionId ?? "n/a"}${s.lowestWinrateChampionWR != null ? ` • ${(s.lowestWinrateChampionWR*100).toFixed(1)}%` : ""}</div>
              </div>
            </div>

            <div class="footnote">
              LP deltas are best-effort. Dodges/remakes/promos and multi-game gaps can skew “average LP gain/loss.”
            </div>
          </div>
        </div>
      `;
      cards.appendChild(card);
    }

    // Update the "(x minutes ago)" every 10s without refetching
    setInterval(() => {
      const updatedIso2 = data?.updatedAt?.iso ?? data?.updatedAt;
      const { display: d2, rel: r2 } = formatLastUpdated(updatedIso2);
      document.getElementById("updated").textContent = r2 ? `${d2} (${r2})` : d2;
    }, 10000);
  }

  load();
</script>
</body>
</html>
