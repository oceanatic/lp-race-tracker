<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LP Race Tracker</title>
  <style>
    body { font-family: system-ui, Arial; margin: 24px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; }
    .muted { color: #666; font-size: 0.9em; }
    h2 { margin: 0 0 8px; }
    ul { margin: 8px 0 0 18px; }
    code { background: #f5f5f5; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>LP Race Tracker (NA Solo/Duo)</h1>
  <div class="muted" id="updated"></div>
  <div class="row" id="cards"></div>

<script>
let _updatedAtIso = null;
let _updatedAtDisplay = null;
let _relativeTimer = null;

function plural(n, word) {
  return n === 1 ? word : word + "s";
}

function formatRelative(msAgo) {
  // Guard
  if (!Number.isFinite(msAgo)) return "";

  if (msAgo < 0) msAgo = 0;

  const sec = Math.floor(msAgo / 1000);
  if (sec < 10) return "(just now)";
  if (sec < 60) return `(${sec} ${plural(sec, "second")} ago)`;

  const min = Math.floor(sec / 60);
  if (min < 60) return `(${min} ${plural(min, "minute")} ago)`;

  const hr = Math.floor(min / 60);
  if (hr < 24) return `(${hr} ${plural(hr, "hour")} ago)`;

  const day = Math.floor(hr / 24);
  return `(${day} ${plural(day, "day")} ago)`;
}

function renderUpdated() {
  const el = document.getElementById("updated");

  // Backward compatibility: updatedAt might be a string in older JSON
  if (!_updatedAtIso && !_updatedAtDisplay) {
    el.textContent = "Last Updated: unknown";
    return;
  }

  // If we have ISO, compute relative in real time
  let rel = "";
  if (_updatedAtIso) {
    const t = Date.parse(_updatedAtIso);
    if (!Number.isNaN(t)) {
      rel = " " + formatRelative(Date.now() - t);
    }
  }

  // Prefer display string (EST/EDT baked by Python)
  if (_updatedAtDisplay) {
    el.textContent = _updatedAtDisplay + rel;
  } else {
    // Fallback: show ISO if no display is provided
    el.textContent = "Last Updated: " + _updatedAtIso + rel;
  }
}

async function load() {
  const res = await fetch("./data.json", { cache: "no-store" });
  const data = await res.json();

  // Handle both formats:
  // New format: updatedAt = { iso, display }
  // Old format: updatedAt = "2025-...Z"
  if (data.updatedAt && typeof data.updatedAt === "object") {
    _updatedAtIso = data.updatedAt.iso || null;
    _updatedAtDisplay = data.updatedAt.display || null;
  } else if (typeof data.updatedAt === "string") {
    _updatedAtIso = data.updatedAt;
    _updatedAtDisplay = null;
  } else {
    _updatedAtIso = null;
    _updatedAtDisplay = null;
  }

  renderUpdated();

  // Update relative time once per minute without refetching
  if (_relativeTimer) clearInterval(_relativeTimer);
  _relativeTimer = setInterval(renderUpdated, 60 * 1000);

  const cards = document.getElementById("cards");
  cards.innerHTML = "";

  for (const [key, p] of Object.entries(data.players || {})) {
    const cur = p.current;
    const s = p.stats || {};
    const winrate = cur && cur.winrate != null ? (cur.winrate * 100).toFixed(1) + "%" : "n/a";

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <h2>${p.riotId}</h2>
      <div class="muted">Key: <code>${key}</code></div>
      <ul>
        <li><b>Current:</b> ${cur ? `${cur.tier} ${cur.division} — ${cur.lp} LP` : "Unranked / placements"}</li>
        <li><b>Peak (since tracking):</b> ${p.peak ? `${p.peak.tier} ${p.peak.division} — ${p.peak.lp} LP` : "n/a"}</li>
        <li><b>Games:</b> ${cur ? cur.games : (s.games ?? 0)} (W ${cur ? cur.wins : (s.wins ?? 0)} / L ${cur ? cur.losses : (s.losses ?? 0)})</li>
        <li><b>Overall winrate:</b> ${winrate}</li>
        <li><b>Total playtime:</b> ${s.totalPlaytimeHMS || "0:00:00"}</li>
        <li><b>Most played champ ID:</b> ${s.mostPlayedChampionId ?? "n/a"}</li>
        <li><b>Highest WR champ ID (min 5 games):</b> ${s.highestWinrateChampionId ?? "n/a"}</li>
        <li><b>Lowest WR champ ID (min 5 games):</b> ${s.lowestWinrateChampionId ?? "n/a"}</li>
        <li><b>Avg LP gain / win (est.):</b> ${s.avgLpGainPerWin != null ? s.avgLpGainPerWin.toFixed(2) : "n/a"}</li>
        <li><b>Avg LP loss / loss (est.):</b> ${s.avgLpLossPerLoss != null ? s.avgLpLossPerLoss.toFixed(2) : "n/a"}</li>
      </ul>
      <div class="muted">LP deltas are best-effort (dodges/promos/multi-game gaps can skew).</div>
    `;
    cards.appendChild(card);
  }
}

load();
</script>
</body>
</html>
